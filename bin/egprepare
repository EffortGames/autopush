#!/usr/bin/env bash
#
# Prepare local changes for publishing;
# - Sets up a feature branch if not already on one.
# - Stages the local directory and commits using an autogenerated message.
# - Records the change in the shared database for later publishing.
#
set -e -o pipefail

feature=$1
if [ -z "${feature}" ]; then
  # alternatively, check for a feature/ or bugfix/ branch
  feature=$(_egfeature)
fi

if [ -z "${feature}" ]; then
  echo "Usage: egprepare <feature>"
  exit 1
fi

branch=$(git rev-parse --abbrev-ref HEAD)
# when on the default branch, create a new feature branch
if [[ "${branch}" == "master" || "${branch}" == "main" ]]; then
  echo "On a default branch. Creating a new feature branch."
  git checkout -b "feature/${feature}"
fi

# when on a feature branch, ensure it is the correct one
branch_feature=$(_egfeature)
if [ "${feature}" != "${branch_feature}" ]; then
  echo "Not on a feature branch. Aborting."
  exit 1
fi

autocommit

_egrecord
