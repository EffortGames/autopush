#!/usr/bin/env bash
#
# Stages the local directory and commits using an autogenerated message.
# Fetches, rebases and pushes the current branch to the remote.
# Supports remote `origin` only
#
set -e
set -o pipefail

function print() {
  COLOR='\033[0;36m'
  COLOR_END='\033[0m'
  printf -- "-- $COLOR$1$COLOR_END\n"
}

git autocommit

branch=$(git symbolic-ref --short HEAD)

print "fetching origin"
git fetch origin

print "verifying origin/${branch} exists"
if git ls-remote --exit-code --heads origin "${branch}"; then
  print "rebasing on origin/${branch}"
  if ! git rebase "origin/${branch}"; then
    git rebase --abort
    exit 1
  fi
fi

printf "pushing to origin/${branch}"
git push origin "${branch}"
