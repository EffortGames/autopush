#!/usr/bin/env bash
#
# Amends local changes to the last commit and somewhat safely force pushes it.
# Supports remote `origin` only
#
set -e -o pipefail

branch=$(git rev-parse --abbrev-ref HEAD)
git fetch origin --quiet

# warn if branch is `master` or `main`
if [[ "${branch}" == "master" || "${branch}" == "main" ]]; then
  URL=$(git remote get-url origin)
  echo "WARNING: You are about to amend to ${branch} of ${URL}."
  echo "Are you sure you want to continue? (y/N)"
  read -r answer
  if [[ "${answer}" != "y" ]]; then
    exit 1
  fi
fi

# ensure the latest local commit matches the latest remote commit before force pushing
latest_local=$(git rev-parse "${branch}")
latest_remote=$(git rev-parse "origin/${branch}")
if [ "${latest_local}" != "${latest_remote}" ]; then
    echo "will not force push; the local branch is not up to date with the remote branch. rebase before running eg-amend."
    exit 1
fi

git commit -a --amend --no-edit --no-verify
git push origin "${branch}" -f
